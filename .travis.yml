language: python

cache: pip

python:
  - "3.6"
  - "3.6-dev"
  - "3.7-dev"

services:
  - postgresql
  - redis-server
  - docker

install:
  - pip install -r requirements.txt

script:
  - flake8
  - ./manage.py migrate
  - pytest
  - docker build -t pyslackers/website:latest -t pyslackers/website:$TRAVIS_BUILD_NUMBER .

after_success:
  - test $TRAVIS_BRANCH = "master" &&
    test $TRAVIS_PYTHON_VERSION == "3.6" &&
    docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD" &&
    docker push pyslackers/website:latest &&
    docker push pyslackers/website:$TRAVIS_BUILD_NUMBER

matrix:
  allow_failures:
    - python: "3.7-dev"